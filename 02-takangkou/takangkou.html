<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1877 歷史重現：Cepo' 戰役與被遺忘的誓約</title>
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Leaflet CSS & JS will be loaded dynamically in Module 3 -->

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700;900&family=Noto+Sans+TC:wght@300;400;500;700&family=Playfair+Display:wght@700&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f5f5f0; /* Paper texture color */
            color: #2c2c2c;
        }
        
        h1, h2, h3, .serif {
            font-family: 'Noto Serif TC', 'Playfair Display', serif;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Leaflet Map specific fixes */
        .leaflet-container {
            z-index: 0; 
            background: #f5f5f0;
            border-radius: 0.75rem;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Helper Component for Safe Lucide Rendering ---
        const LucideIcon = ({ name, className = "" }) => {
            const ref = useRef(null);

            useEffect(() => {
                if (window.lucide && ref.current) {
                    const i = document.createElement('i');
                    i.setAttribute('data-lucide', name);
                    if (className) {
                        i.setAttribute('class', className);
                    }
                    ref.current.innerHTML = '';
                    ref.current.appendChild(i);
                    window.lucide.createIcons({
                        root: ref.current,
                        nameAttr: 'data-lucide'
                    });
                }
            }, [name, className]);

            return <span ref={ref} className="inline-flex items-center justify-center shrink-0"></span>;
        };

        const Icons = {
            BookOpen: (props) => <LucideIcon name="book-open" {...props} />,
            Scale: (props) => <LucideIcon name="scale" {...props} />,
            Map: (props) => <LucideIcon name="map" {...props} />,
            Users: (props) => <LucideIcon name="users" {...props} />,
            User: (props) => <LucideIcon name="user" {...props} />,
            Brain: (props) => <LucideIcon name="brain" {...props} />,
            ArrowRight: (props) => <LucideIcon name="arrow-right" {...props} />,
            Info: (props) => <LucideIcon name="info" {...props} />,
            MapPin: (props) => <LucideIcon name="map-pin" {...props} />,
            ScrollText: (props) => <LucideIcon name="scroll-text" {...props} />,
            MessageCircle: (props) => <LucideIcon name="message-circle" {...props} />,
            Hourglass: (props) => <LucideIcon name="hourglass" {...props} />,
            Languages: (props) => <LucideIcon name="languages" {...props} />
        };

        // --- Bilingual Data ---

        const modules = [
            { id: 1, title: { zh: "引言", en: "Introduction" }, icon: "book-open" },
            { id: 2, title: { zh: "史觀對照", en: "Perspectives" }, icon: "scale" },
            { id: 3, title: { zh: "地圖資料", en: "Map Data" }, icon: "map" },
            { id: 4, title: { zh: "角色扮演", en: "Role Play" }, icon: "user" },
            { id: 5, title: { zh: "關鍵人物", en: "Key Figures" }, icon: "users" },
            { id: 6, title: { zh: "歷史反思", en: "Reflection" }, icon: "brain" },
        ];

        const content = {
            zh: {
                appTitle: "Cepo' 1877",
                appSubtitle: "大港口事件互動教學",
                footer: "本網頁依據《大港口事件》官方檔案與口述歷史設計。旨在呈現歷史的多面性，促進批判性思考。",
                startBtn: "開始探索",
                officialSource: "清朝官方文獻",
                oralSource: "部落口述歷史",
                mapInstruction: "地圖資料來自真實地理座標，點擊圓點查看歷史事件",
                mapLoading: "地圖資源載入中...",
                mapError: "地圖載入失敗，請檢查網路連線",
                coords: "座標",
                clickPrompt: "請點擊左側地圖上的亮點",
                legend: "紅色：衝突點 | 藍色：清軍據點 | 綠色：部落據點",
                scenarioTitle: "歷史抉擇",
                scenarioDesc: "情境描述",
                option: "選項",
                feedbackTitle: "歷史回饋",
                nextScenario: "下一題",
                scenarioComplete: "已完成所有情境體驗",
                officialSide: "清朝勢力",
                localSide: "阿美族部落",
                reflectionTitle: "歷史的反思",
                reflectionSubtitle: "從「勝者歷史」轉向多元視角的思考",
                placeholder: "寫下你的想法..."
            },
            en: {
                appTitle: "Cepo' 1877",
                appSubtitle: "The Cepo' Incident",
                footer: "Based on official records and oral history of the Cepo' Incident. Designed to foster critical thinking.",
                startBtn: "Start Exploring",
                officialSource: "Qing Official Records",
                oralSource: "Tribal Oral History",
                mapInstruction: "Real geographical data. Click markers to view historical events.",
                mapLoading: "Loading Map Resources...",
                mapError: "Map failed to load. Check connection.",
                coords: "Coords",
                clickPrompt: "Click a highlighted point on the map",
                legend: "Red: Conflict | Blue: Qing Camp | Green: Tribal Site",
                scenarioTitle: "Historical Decision",
                scenarioDesc: "Context",
                option: "Option",
                feedbackTitle: "Historical Feedback",
                nextScenario: "Next Scenario",
                scenarioComplete: "All Scenarios Completed",
                officialSide: "Qing Forces",
                localSide: "Amis Tribe",
                reflectionTitle: "Historical Reflection",
                reflectionSubtitle: "Moving from 'Victor's History' to Multiple Perspectives",
                placeholder: "Write down your thoughts..."
            }
        };

        const module1Data = {
            zh: {
                title: "當「王法」遇見「祖靈」",
                subtitle: "一場關於生存、尊嚴與背叛的 Cepo' 戰役",
                p1: "時間回到光緒3年（1877）。清朝政府為了對抗日本威脅，推動「開山撫番」。總兵吳光亮率軍試圖打通後山，將這片土地納入版圖。",
                p2: "然而，在秀姑巒溪口，Cepo'（大港口）部落早已在此建立了強大的文明。當火槍遇上祭典，勞役壓垮了尊嚴，平靜的溪口即將掀起滔天巨浪。這不僅是武力對決，更是兩種世界觀的劇烈碰撞。"
            },
            en: {
                title: "When 'Imperial Law' Meets 'Ancestral Spirits'",
                subtitle: "The Battle of Cepo': Survival, Dignity, and Betrayal",
                p1: "The year is 1877. To counter the Japanese threat, the Qing government promotes the 'Open the Mountains and Pacify the Savages' policy. General Wu Guangliang leads troops to open up Eastern Taiwan.",
                p2: "However, at the mouth of the Xiuguluan River, the Cepo' tribe had long established a powerful civilization. When muskets met rituals, and forced labor crushed dignity, a storm brewed. This was not just a battle of arms, but a violent collision of two worldviews."
            }
        };

        const historyEvents = [
            {
                title: { zh: "事件 A：衝突起因", en: "Event A: The Cause" },
                official: {
                    title: { zh: "兇番梗化", en: "Barbarian Obstinacy" },
                    desc: { 
                        zh: "官方記載阿棉、烏漏兩社「梗化滋事」（頑固不化、滋生事端），甚至主動攻擊營壘，殺害官兵與通事，因此必須出兵剿滅。", 
                        en: "Official records state the tribes were 'obstinate and causing trouble', attacking camps and killing officials, necessitating a military suppression." 
                    }
                },
                oral: {
                    title: { zh: "被侵犯的日常與無禮的通事", en: "Violation of Daily Life" },
                    desc: { 
                        zh: "通事林東涯作威作福，強迫青年在庫拉若（勞役）期間幫他抬轎，甚至干擾豐年祭、強娶部落婦女。青年領袖 Kafu'ok 忍無可忍，為了保護部落，才在半路伏殺了林東涯。", 
                        en: "Interpreter Lin Dongya abused power, forced labor during rituals, and harassed women. Tribal leader Kafu'ok, protecting his people, ambushed and killed Lin." 
                    }
                }
            },
            {
                title: { zh: "事件 B：戰役過程", en: "Event B: The Battle" },
                official: {
                    title: { zh: "洋槍火砲的勝利", en: "Victory of Modern Arms" },
                    desc: { 
                        zh: "清軍記載孫開華率領「擢勝軍」使用洋火箭（Western rockets）連環轟擊，甚至放火燒山，攻破了納納社與阿棉山社的巢穴，宣稱「九日三捷」。", 
                        en: "Qing forces, led by Sun Kaihua, used Western rockets to bombard and burn the mountains, destroying tribal strongholds and claiming swift victory." 
                    }
                },
                oral: {
                    title: { zh: "英勇抵抗與意外", en: "Heroic Resistance & Accident" },
                    desc: { 
                        zh: "阿美族英雄 Kafu'ok 力大無窮，帶領青年多次擊退清軍。但在追擊騎兵時，Kafu'ok 不幸意外被馬匹撞擊身亡，導致部落士氣瓦解，才被迫撤退。", 
                        en: "Hero Kafu'ok led youths to repel Qing troops multiple times. However, he was accidentally killed by a horse during a pursuit, crushing tribal morale." 
                    }
                }
            },
            {
                title: { zh: "事件 C：事件結局", en: "Event C: The Aftermath" },
                official: {
                    title: { zh: "震服歸順", en: "Submission" },
                    desc: { 
                        zh: "官方奏摺宣稱，在攻破巢穴後，部落頭目馬腰兵（Mayaw Eping）等人被擒獲並正法，其餘族人「震服」，全部剃髮歸順。", 
                        en: "Official reports claim that after the stronghold fell, Chief Mayaw Eping was captured and executed, while the rest of the tribe submitted and shaved their heads." 
                    }
                },
                oral: {
                    title: { zh: "致意後的誘殺", en: "The Treacherous Massacre" },
                    desc: { 
                        zh: "清軍假意和解，邀請部落壯丁參加「慶功宴」。在宴會中，清軍趁族人酒酣耳熱之際，關閉營門進行大屠殺，僅有一人翻牆逃出。這是著名的「大港口事件」慘案。", 
                        en: "Qing troops feigned peace, inviting men to a banquet. Once inside, the gates were locked, and a massacre ensued. Only one escaped. This is the 'Cepo' Incident' tragedy." 
                    }
                }
            }
        ];

        const mapLocations = [
            { 
                id: 1, 
                name: { zh: "Cepo' (大港口部落)", en: "Cepo' (The Big Port)" }, 
                lat: 23.5186, 
                lng: 121.5048, 
                hex: "#dc2626", 
                desc: { zh: "秀姑巒溪出海口北岸。事件發生時阿美族的大型部落，人口眾多且強盛，是戰役的主要衝突點。", en: "North bank of Xiuguluan River mouth. A large and powerful Amis settlement, the main point of conflict." }
            },
            { 
                id: 2, 
                name: { zh: "Napololan (靜浦/清兵營)", en: "Napololan (Qing Camp)" }, 
                lat: 23.5145, 
                lng: 121.5030, 
                hex: "#2563eb", 
                desc: { zh: "秀姑巒溪出海口南岸。阿美族語意指「有營房的地方」。據口述歷史，這裡是最後「關門誘殺」160 多名壯丁的慘案現場。", en: "South bank. Amis for 'Place of Barracks'. According to oral history, the site of the massacre of over 160 men." }
            },
            { 
                id: 3, 
                name: { zh: "成廣澳 (Cheng Guang Ao)", en: "Cheng Guang Ao" }, 
                lat: 23.1633, 
                lng: 121.3970, 
                hex: "#2563eb", 
                desc: { zh: "今臺東縣成功鎮小港。吳光亮在此設立「糧局」，作為清軍後勤補給基地。清軍主力由此登陸北進。", en: "Present-day Chenggong. Wu Guangliang established a supply base here. Qing main forces landed here to march north." }
            },
            { 
                id: 4, 
                name: { zh: "Cilangasan (奇拉雅山)", en: "Cilangasan (Holy Mt.)" }, 
                lat: 23.4735, 
                lng: 121.4870, 
                hex: "#16a34a", 
                desc: { zh: "阿美族聖山(八里灣山)。戰敗後，倖存的老弱婦孺連夜逃往此山避難。是族人在絕望中尋求庇護與重建力量的聖地。", en: "The Amis Holy Mountain. After defeat, survivors fled here for refuge. A place of sanctuary and rebuilding." }
            },
            { 
                id: 5, 
                name: { zh: "Kiwit (奇美部落)", en: "Kiwit Tribe" }, 
                lat: 23.4913, 
                lng: 121.4312, 
                hex: "#16a34a", 
                desc: { zh: "秀姑巒溪中游深山。通事林東涯被殺地點。該部落與大港口部落有氏族淵源，在戰役中支援作戰。", en: "Deep in the mountains. Where interpreter Lin was killed. Allied with Cepo', they supported the resistance." }
            }
        ];

        const scenarios = [
            {
                role: { zh: "阿美族青年階級 (Pakalongay/Kapah)", en: "Amis Youth (Pakalongay)" },
                context: { 
                    zh: "現在是 7 月，正是部落準備神聖「豐年祭」的關鍵時刻。清朝通事林東涯要求你們立刻去修築營房。如果你不去，他威脅要帶軍隊來。這嚴重違反了部落祭典的禁忌。", 
                    en: "It is July, time for the sacred Harvest Festival. The Qing interpreter demands you build barracks immediately, threatening military force if you refuse. This violates sacred taboos." 
                },
                options: [
                    {
                        text: { zh: "忍耐服從：暫時放下祭典工作去服勞役。", en: "Obey: Pause ritual work to serve labor." },
                        result: { 
                            zh: "雖然暫時沒事，但清軍的要求越來越過分，甚至干擾儀式，這是對祖靈與農神的極大不敬，部落的秩序（年齡階級）瀕臨瓦解。", 
                            en: "Temporary peace, but demands grow. Rituals are disrupted, disrespecting ancestors. Tribal order begins to crumble." 
                        }
                    },
                    {
                        text: { zh: "憤怒反抗：拒絕勞役，甚至拆毀營房。", en: "Resist: Refuse labor, destroy barracks." },
                        result: { 
                            zh: "你的選擇與當年的青年領袖 Kafu'ok 一樣！部落青年無法忍受勞役干擾祭典與對婦女的騷擾，選擇拆毀營房並殺死林東涯。這捍衛了尊嚴，但也引發了戰爭。", 
                            en: "Like Kafu'ok! Unable to bear the oppression and harassment, the youth rebelled and killed Lin. Dignity was defended, but war was ignited." 
                        }
                    }
                ]
            },
            {
                role: { zh: "部落頭目 Mayaw Eping (馬腰兵)", en: "Chief Mayaw Eping" },
                context: { 
                    zh: "戰事持續數月，糧食短缺。清軍將領吳光亮表示願意「既往不咎」，只要部落歸順並派壯丁去搬運和解禮物（酒/糧），就能和平共處。", 
                    en: "War has lasted months; food is scarce. General Wu offers peace if the tribe submits and sends men to carry 'reconciliation gifts' (wine/food)." 
                },
                options: [
                    {
                        text: { zh: "拒絕前往：繼續逃往深山，即使餓死也不投降。", en: "Refuse: Flee deeper into mountains." },
                        result: { 
                            zh: "這或許能保住性命，但族人可能面臨飢荒與流離失所，且在深山中難以維繫大型部落的生存。", 
                            en: "Lives might be saved, but the tribe faces starvation and displacement. Survival as a large group is difficult." 
                        }
                    },
                    {
                        text: { zh: "答應前往：為了保局部落婦孺，賭一把信任清軍。", en: "Accept: Trust the Qing to save the women/children." },
                        result: { 
                            zh: "這是當年頭目所做的沉重決定。然而，這是一個陷阱。當壯丁們進入營地時，清軍關閉營門進行屠殺。你為了族人生存付出了代價，這段悲劇被族人永遠銘記。", 
                            en: "The historical choice. It was a trap. The men were massacred inside the camp. You paid the ultimate price for survival; a tragedy remembered forever." 
                        }
                    }
                ]
            }
        ];

        const characters = [
            { 
                name: { zh: "吳光亮", en: "Wu Guangliang" }, 
                title: { zh: "清朝總兵", en: "Qing General" }, 
                desc: { zh: "負責「開山撫番」中路任務。手段採取「剿撫兼施」。除了軍事鎮壓，也被部落記憶指控使用了「誘殺」手段來瓦解反抗勢力。", en: "Tasked with pacifying the East. Used both suppression and appeasement. Accused by oral history of using treachery and massacres." }, 
                side: "official" 
            },
            { 
                name: { zh: "林東涯", en: "Lin Dongya" }, 
                title: { zh: "清朝通事", en: "Interpreter" }, 
                desc: { zh: "官方稱被害者，口述歷史中則是作威作福、強徵勞役、強娶婦女的惡霸。其傲慢行為成為衝突導火線。", en: "Official victim, but a tyrant in oral history. Forced labor and harassed women. His arrogance sparked the conflict." }, 
                side: "official" 
            },
            { 
                name: { zh: "Mayaw Eping", en: "Mayaw Eping" }, 
                title: { zh: "部落頭目", en: "Tribal Chief" }, 
                desc: { zh: "Cepo' 領袖。在清軍壓力與部落尊嚴間尋求平衡。為了換取和平接受招降，卻不幸在清軍營地中遭捕殺犧牲。", en: "Cepo' leader. Sought balance between dignity and survival. Accepted surrender for peace, but was betrayed and killed." }, 
                side: "local" 
            },
            { 
                name: { zh: "Kafu'ok", en: "Kafu'ok" }, 
                title: { zh: "部落英雄", en: "Tribal Hero" }, 
                desc: { zh: "青年階級領袖，力大無窮。鷹派代表，處決了欺壓族人的通事。在戰役中多次擊退清兵，後意外身亡。", en: "Youth leader of immense strength. Executed the oppressor. Repelled Qing troops multiple times before dying in an accident." }, 
                side: "local" 
            }
        ];

        const reflectionQuestions = [
            {
                title: { zh: "「事件」還是「戰爭」？", en: "'Incident' or 'War'?" },
                text: { 
                    zh: "漢人歷史常稱此為「大港口事件」，但在阿美族觀點中，這是「Lalood (戰爭)」。你認為用「事件」和「戰爭」這兩個詞來描述這段歷史，有什麼本質上的不同？", 
                    en: "Han history calls it an 'Incident', Amis view it as 'Lalood' (War). How does the choice of word change the perception of history?" 
                }
            },
            {
                title: { zh: "誰的歷史？誰的記憶？", en: "Whose History?" },
                text: { 
                    zh: "清朝官方檔案記載的是「平定兇番」，而部落口述流傳的是「誘殺與背叛」。為什麼同一個事件會有這麼大的落差？", 
                    en: "Official records say 'Pacifying Savages', oral history says 'Betrayal'. Why is there such a huge gap between the two narratives?" 
                }
            },
            {
                title: { zh: "歷史傷痕與現代共存", en: "Trauma & Coexistence" },
                text: { 
                    zh: "這場戰役導致了 Cepo' 部落的離散。今天的我們回顧這段歷史，對於原住民族的轉型正義與族群共存，能帶來什麼樣的啟示？", 
                    en: "The tribe was scattered. What can this history teach us today about transitional justice and ethnic coexistence?" 
                }
            }
        ];

        // --- Components ---

        const Module1 = ({ onNext, lang }) => (
            <div className="flex flex-col items-center justify-center min-h-[60vh] text-center space-y-8 fade-in p-8">
                <div className="max-w-4xl space-y-6">
                    <h1 className="text-5xl md:text-7xl font-black text-stone-900 tracking-wider mb-2">
                        1877
                    </h1>
                    <h2 className="text-3xl md:text-5xl font-bold text-red-900 serif border-b-4 border-stone-800 pb-6 inline-block leading-tight">
                        {module1Data[lang].title}
                    </h2>
                    <p className="text-xl md:text-2xl text-stone-700 font-medium mt-6">
                        {module1Data[lang].subtitle}
                    </p>
                    
                    <div className="bg-white p-6 md:p-10 rounded-lg shadow-lg text-left border-l-8 border-red-800 mt-10">
                        <p className="text-lg leading-relaxed text-stone-600 mb-4">
                            {module1Data[lang].p1}
                        </p>
                        <p className="text-lg leading-relaxed text-stone-600">
                            {module1Data[lang].p2}
                        </p>
                    </div>

                    <button 
                        onClick={onNext}
                        className="mt-8 px-8 py-3 bg-stone-800 text-stone-100 rounded-full text-lg hover:bg-red-900 transition-colors flex items-center mx-auto gap-2"
                    >
                        {content[lang].startBtn} <Icons.ArrowRight className="w-5 h-5" />
                    </button>
                </div>
            </div>
        );

        const Module2 = ({ lang }) => {
            const [activeEvent, setActiveEvent] = useState(0);

            return (
                <div className="flex flex-col h-full fade-in space-y-6">
                    <div className="text-center mb-4">
                        <h2 className="text-3xl font-bold serif text-stone-800">{modules[1].title[lang]}</h2>
                    </div>

                    <div className="flex flex-wrap justify-center gap-2 mb-4">
                        {historyEvents.map((ev, idx) => (
                            <button 
                                key={idx}
                                onClick={() => setActiveEvent(idx)}
                                className={`px-4 py-2 rounded-full text-sm md:text-base font-bold transition-all ${activeEvent === idx ? 'bg-stone-800 text-white shadow-lg' : 'bg-stone-200 text-stone-600 hover:bg-stone-300'}`}
                            >
                                {ev.title[lang]}
                            </button>
                        ))}
                    </div>

                    <div className="grid md:grid-cols-2 gap-6 md:gap-12 flex-grow items-stretch">
                        {/* Official Side */}
                        <div className="bg-stone-100 border-2 border-stone-300 p-6 rounded-xl relative shadow-sm">
                            <div className="absolute -top-4 left-1/2 transform -translate-x-1/2 bg-stone-700 text-white px-4 py-1 rounded text-sm tracking-widest font-bold uppercase whitespace-nowrap">
                                {content[lang].officialSource}
                            </div>
                            <div className="mt-4 text-center">
                                <div className="text-4xl text-stone-300 mb-2 flex justify-center">
                                    <Icons.ScrollText className="w-10 h-10" />
                                </div>
                                <h3 className="text-xl font-bold text-stone-800 mb-3">{historyEvents[activeEvent].official.title[lang]}</h3>
                                <p className="text-stone-700 leading-relaxed text-justify">
                                    {historyEvents[activeEvent].official.desc[lang]}
                                </p>
                            </div>
                        </div>

                        {/* Oral History Side */}
                        <div className="bg-red-50 border-2 border-red-200 p-6 rounded-xl relative shadow-sm">
                            <div className="absolute -top-4 left-1/2 transform -translate-x-1/2 bg-red-700 text-white px-4 py-1 rounded text-sm tracking-widest font-bold uppercase whitespace-nowrap">
                                {content[lang].oralSource}
                            </div>
                            <div className="mt-4 text-center">
                                <div className="text-4xl text-red-200 mb-2 flex justify-center">
                                    <Icons.MessageCircle className="w-10 h-10" />
                                </div>
                                <h3 className="text-xl font-bold text-red-900 mb-3">{historyEvents[activeEvent].oral.title[lang]}</h3>
                                <p className="text-red-900 leading-relaxed text-justify">
                                    {historyEvents[activeEvent].oral.desc[lang]}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const Module3 = ({ lang }) => {
            const [selectedLoc, setSelectedLoc] = useState(null);
            const [mapReady, setMapReady] = useState(false);
            const [loadError, setLoadError] = useState(false);
            const mapContainerRef = useRef(null);
            const mapInstanceRef = useRef(null);
            const markersRef = useRef([]);

            // Robust Dynamic Script Loader
            useEffect(() => {
                const scriptSrc = "https://unpkg.com/leaflet@1.9.4/dist/leaflet.js";
                let intervalId = null;
                let timeoutId = null;

                const checkReady = () => {
                    return window.L && typeof window.L.map === 'function';
                };

                if (checkReady()) {
                    setMapReady(true);
                    return;
                }

                const existingScript = document.querySelector(`script[src="${scriptSrc}"]`);
                if (!existingScript) {
                    const cssLink = document.createElement("link");
                    cssLink.href = "https://unpkg.com/leaflet@1.9.4/dist/leaflet.css";
                    cssLink.rel = "stylesheet";
                    document.head.appendChild(cssLink);

                    const script = document.createElement("script");
                    script.src = scriptSrc;
                    script.async = true;
                    document.head.appendChild(script);
                }

                intervalId = setInterval(() => {
                    if (checkReady()) {
                        setMapReady(true);
                        clearInterval(intervalId);
                        clearTimeout(timeoutId);
                    }
                }, 100);

                timeoutId = setTimeout(() => {
                    clearInterval(intervalId);
                    if (!checkReady()) {
                        setLoadError(true);
                    }
                }, 10000);

                return () => {
                    clearInterval(intervalId);
                    clearTimeout(timeoutId);
                };
            }, []);

            // Init Map and Update Markers on Language Change
            useEffect(() => {
                if (!mapReady || !mapContainerRef.current) return;

                // Init Map if not exists
                if (!mapInstanceRef.current) {
                    try {
                        const map = window.L.map(mapContainerRef.current).setView([23.40, 121.48], 10);
                        window.L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            attribution: '&copy; OpenStreetMap',
                            maxZoom: 18,
                        }).addTo(map);
                        mapInstanceRef.current = map;
                    } catch (e) {
                        console.error("Map Init Error", e);
                        return;
                    }
                }

                // Clear existing markers
                if (markersRef.current.length > 0) {
                    markersRef.current.forEach(m => m.remove());
                    markersRef.current = [];
                }

                const map = mapInstanceRef.current;

                // Add markers with current language
                const markers = mapLocations.map(loc => {
                    const marker = window.L.circleMarker([loc.lat, loc.lng], {
                        color: 'white',
                        fillColor: loc.hex,
                        fillOpacity: 0.8,
                        radius: 12,
                        weight: 2
                    }).addTo(map);

                    marker.bindTooltip(loc.name[lang], {
                        permanent: false,
                        direction: 'top',
                        offset: [0, -10]
                    });

                    marker.on('click', () => {
                        markersRef.current.forEach(m => m.setStyle({ radius: 12, weight: 2 }));
                        marker.setStyle({ radius: 16, weight: 4 });
                        setSelectedLoc(loc);
                    });

                    return marker;
                });

                markersRef.current = markers;
                const group = new window.L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.2));

            }, [mapReady, lang]); // Re-run when language changes

            return (
                <div className="flex flex-col h-full fade-in">
                    <h2 className="text-3xl font-bold serif text-stone-800 text-center mb-2">{modules[2].title[lang]}</h2>
                    <p className="text-center text-stone-600 mb-6">{content[lang].mapInstruction}</p>

                    <div className="flex flex-col md:flex-row gap-8 items-stretch flex-grow">
                        <div className="w-full md:w-1/2 min-h-[400px] relative rounded-xl border-4 border-stone-300 shadow-inner overflow-hidden">
                            <div ref={mapContainerRef} className="w-full h-full absolute inset-0 bg-stone-200 z-0" style={{ minHeight: '400px' }}></div>
                            
                            {!mapReady && !loadError && (
                                <div className="absolute inset-0 flex flex-col items-center justify-center bg-stone-100 z-10 opacity-90">
                                    <Icons.Map className="w-12 h-12 text-stone-400 mb-2 animate-pulse" />
                                    <span className="text-stone-500 font-bold">{content[lang].mapLoading}</span>
                                </div>
                            )}
                             {loadError && (
                                <div className="absolute inset-0 flex flex-col items-center justify-center bg-stone-100 z-10 text-red-600">
                                    <span className="font-bold text-lg mb-2">{content[lang].mapError}</span>
                                </div>
                            )}
                        </div>

                        <div className="w-full md:w-1/2 bg-white p-6 rounded-xl shadow-lg border border-stone-200 min-h-[300px] flex flex-col justify-center">
                            {selectedLoc ? (
                                <div className="fade-in">
                                    <h3 className="text-2xl font-bold text-stone-800 mb-2 border-b pb-2 flex items-center gap-2">
                                        <span className="w-4 h-4 rounded-full inline-block" style={{ backgroundColor: selectedLoc.hex }}></span>
                                        {selectedLoc.name[lang]}
                                    </h3>
                                    <p className="text-lg text-stone-700 leading-relaxed">
                                        {selectedLoc.desc[lang]}
                                    </p>
                                    <div className="mt-4 text-xs text-stone-400 font-mono">
                                        {content[lang].coords}: {selectedLoc.lat}, {selectedLoc.lng}
                                    </div>
                                </div>
                            ) : (
                                <div className="text-center text-stone-400">
                                    <div className="flex justify-center mb-2">
                                        <Icons.MapPin className="w-12 h-12 opacity-50" />
                                    </div>
                                    <p>{content[lang].clickPrompt}</p>
                                    <p className="text-sm mt-2 opacity-70">{content[lang].legend}</p>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const Module4 = ({ lang }) => {
            const [scenarioIdx, setScenarioIdx] = useState(0);
            const [feedback, setFeedback] = useState(null);

            // Reset when language changes, or handle index mismatch if scenarios array length changed (unlikely)
            useEffect(() => {
                setFeedback(null);
            }, [lang]);

            const currentScenario = scenarios[scenarioIdx];

            const handleChoice = (result) => {
                setFeedback(result);
            };

            const nextScenario = () => {
                if (scenarioIdx < scenarios.length - 1) {
                    setScenarioIdx(scenarioIdx + 1);
                    setFeedback(null);
                }
            };

            return (
                <div className="fade-in max-w-4xl mx-auto">
                    <h2 className="text-3xl font-bold serif text-stone-800 text-center mb-6">{content[lang].scenarioTitle}：{currentScenario.role[lang]}</h2>
                    
                    <div className="bg-white p-6 md:p-8 rounded-xl shadow-lg border-t-4 border-stone-800 mb-6">
                        <div className="flex items-start gap-4 mb-4">
                            <div className="bg-stone-100 p-3 rounded-full hidden md:block">
                                <Icons.User className="w-6 h-6 text-stone-600" />
                            </div>
                            <div>
                                <h3 className="text-lg font-bold text-stone-800 mb-2">{content[lang].scenarioDesc}</h3>
                                <p className="text-stone-700 text-lg leading-relaxed">{currentScenario.context[lang]}</p>
                            </div>
                        </div>
                    </div>

                    {!feedback ? (
                        <div className="grid md:grid-cols-2 gap-4">
                            {currentScenario.options.map((opt, idx) => (
                                <button 
                                    key={idx}
                                    onClick={() => handleChoice(opt.result[lang])}
                                    className="p-6 bg-stone-100 hover:bg-stone-200 border-2 border-stone-300 hover:border-stone-500 rounded-xl text-left transition-all group"
                                >
                                    <span className="font-bold text-stone-800 text-lg block mb-2">{content[lang].option} {String.fromCharCode(65 + idx)}</span>
                                    <span className="text-stone-600 group-hover:text-stone-900">{opt.text[lang]}</span>
                                </button>
                            ))}
                        </div>
                    ) : (
                        <div className="bg-stone-800 text-white p-8 rounded-xl shadow-2xl fade-in relative overflow-hidden">
                            <div className="relative z-10">
                                <h3 className="text-xl font-bold text-yellow-500 mb-4 flex items-center gap-2">
                                    <Icons.Info className="w-6 h-6" /> {content[lang].feedbackTitle}
                                </h3>
                                <p className="text-lg leading-relaxed mb-6">{feedback}</p>
                                {scenarioIdx < scenarios.length - 1 ? (
                                    <button 
                                        onClick={nextScenario}
                                        className="bg-yellow-600 hover:bg-yellow-700 text-white px-6 py-2 rounded-lg font-bold transition-colors"
                                    >
                                        {content[lang].nextScenario}
                                    </button>
                                ) : (
                                    <div className="text-yellow-500 font-bold">{content[lang].scenarioComplete}</div>
                                )}
                            </div>
                            <div className="absolute -right-10 -bottom-10 text-stone-700 opacity-20">
                                <Icons.Hourglass className="w-64 h-64" />
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const Module5 = ({ lang }) => (
            <div className="fade-in">
                <h2 className="text-3xl font-bold serif text-stone-800 text-center mb-8">{modules[4].title[lang]}</h2>
                <div className="grid md:grid-cols-2 lg:grid-cols-4 gap-6">
                    {characters.map((char, idx) => (
                        <div key={idx} className="bg-white rounded-xl shadow-md overflow-hidden hover:shadow-xl transition-shadow border border-stone-200 flex flex-col">
                            <div className={`h-2 ${char.side === 'official' ? 'bg-blue-800' : 'bg-red-700'}`}></div>
                            <div className="p-6 flex-grow">
                                <div className="flex justify-between items-start mb-4">
                                    <div>
                                        <h3 className="text-xl font-bold text-stone-900">{char.name[lang]}</h3>
                                        <span className={`text-xs font-bold px-2 py-1 rounded ${char.side === 'official' ? 'bg-blue-100 text-blue-800' : 'bg-red-100 text-red-800'}`}>
                                            {char.title[lang]}
                                        </span>
                                    </div>
                                </div>
                                <p className="text-stone-600 text-sm leading-relaxed">
                                    {char.desc[lang]}
                                </p>
                            </div>
                        </div>
                    ))}
                </div>
                <div className="mt-8 text-center text-sm text-stone-500 bg-stone-100 p-4 rounded-lg inline-block mx-auto">
                    <span className="inline-block w-3 h-3 bg-blue-800 rounded-full mr-2"></span>{content[lang].officialSide}
                    <span className="inline-block w-3 h-3 bg-red-700 rounded-full ml-4 mr-2"></span>{content[lang].localSide}
                </div>
            </div>
        );

        const Module6 = ({ lang }) => (
            <div className="fade-in max-w-4xl mx-auto space-y-8 pb-10">
                <div className="text-center">
                    <h2 className="text-3xl font-bold serif text-stone-800 mb-2">{content[lang].reflectionTitle}</h2>
                    <p className="text-stone-600">{content[lang].reflectionSubtitle}</p>
                </div>

                <div className="space-y-6">
                    {reflectionQuestions.map((q, idx) => (
                        <div key={idx} className="bg-white p-8 rounded-xl shadow-md border-l-4 border-stone-400">
                            <h3 className="text-xl font-bold text-stone-800 mb-4 flex items-center gap-2">
                                <span className="bg-stone-200 w-8 h-8 rounded-full flex items-center justify-center text-sm">{idx + 1}</span>
                                {q.title[lang]}
                            </h3>
                            <p className="text-stone-600 mb-4">
                                {q.text[lang]}
                            </p>
                            <textarea className="w-full p-4 bg-stone-50 border border-stone-200 rounded-lg focus:ring-2 focus:ring-stone-400 focus:outline-none h-24" placeholder={content[lang].placeholder}></textarea>
                        </div>
                    ))}
                </div>
            </div>
        );

        // --- Main App ---

        const App = () => {
            const [activeModule, setActiveModule] = useState(1);
            const [lang, setLang] = useState('zh'); // 'zh' or 'en'

            useEffect(() => {
                window.scrollTo(0, 0);
            }, [activeModule]);

            const toggleLang = () => {
                setLang(prev => prev === 'zh' ? 'en' : 'zh');
            };

            const renderModule = () => {
                switch(activeModule) {
                    case 1: return <Module1 lang={lang} onNext={() => setActiveModule(2)} />;
                    case 2: return <Module2 lang={lang} />;
                    case 3: return <Module3 lang={lang} />;
                    case 4: return <Module4 lang={lang} />;
                    case 5: return <Module5 lang={lang} />;
                    case 6: return <Module6 lang={lang} />;
                    default: return <Module1 lang={lang} />;
                }
            };

            return (
                <div className="min-h-screen flex flex-col md:flex-row">
                    {/* Sidebar / Navigation */}
                    <nav className="w-full md:w-64 bg-stone-900 text-stone-300 flex-shrink-0 md:h-screen sticky top-0 md:fixed overflow-y-auto z-50 flex flex-col">
                        <div className="p-6 border-b border-stone-800 flex justify-between items-start">
                            <div>
                                <h1 className="text-xl font-bold text-white serif tracking-wide">{content[lang].appTitle}</h1>
                                <p className="text-xs mt-2 text-stone-500">{content[lang].appSubtitle}</p>
                            </div>
                        </div>

                        {/* Language Toggle */}
                        <div className="p-4 border-b border-stone-800">
                            <button 
                                onClick={toggleLang}
                                className="w-full py-2 px-4 rounded bg-stone-800 hover:bg-stone-700 transition-colors flex items-center justify-center gap-2 text-sm font-bold text-white"
                            >
                                <Icons.Languages className="w-4 h-4" />
                                {lang === 'zh' ? 'English' : '中文'}
                            </button>
                        </div>

                        <ul className="flex md:flex-col overflow-x-auto md:overflow-visible flex-grow">
                            {modules.map(mod => (
                                <li key={mod.id} className="flex-shrink-0">
                                    <button 
                                        onClick={() => setActiveModule(mod.id)}
                                        className={`w-full text-left p-4 hover:bg-stone-800 transition-colors flex items-center gap-3 whitespace-nowrap ${activeModule === mod.id ? 'bg-stone-800 text-white border-r-4 border-red-700' : ''}`}
                                    >
                                        <LucideIcon name={mod.icon} className="w-5 h-5" />
                                        <span className="font-medium">{mod.id}. {mod.title[lang]}</span>
                                    </button>
                                </li>
                            ))}
                        </ul>
                    </nav>

                    {/* Main Content Area */}
                    <main className="flex-grow md:ml-64 p-4 md:p-10 min-h-screen relative bg-[url('https://www.transparenttextures.com/patterns/cream-paper.png')]">
                        <div className="max-w-5xl mx-auto h-full">
                            {renderModule()}
                        </div>

                        {/* Footer */}
                        <footer className="mt-12 py-6 border-t border-stone-300 text-center text-stone-500 text-sm">
                            <p>{content[lang].footer}</p>
                        </footer>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>